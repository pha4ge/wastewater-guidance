name: Deploy MkDocs site to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install mkdocs-material pymdown-extensions

      - name: Copy logo into site
        run: |
          mkdir -p guidance_docs/images
          cp phage-logo-thin.png guidance_docs/images/ || true

      - name: Copy README to site index
        run: cp README.md guidance_docs/index.md

      - name: Rewrite internal Markdown links for MkDocs build
        run: |
          echo "Fixing Markdown links (.md â†’ .html and removing guidance_docs/)..."
          cd guidance_docs
          # Replace .md) with .html)
          grep -rl '\.md)' . | xargs sed -i 's/\.md)/.html)/g' || true
          # Remove guidance_docs/ from links
          grep -rl 'guidance_docs/' . | xargs sed -i 's#guidance_docs/##g' || true
          echo "Link rewrite complete."

      - name: Deploy MkDocs site
        run: mkdocs gh-deploy --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
